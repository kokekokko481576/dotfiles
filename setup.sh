#!/bin/bash
#
# setup script (v3.3: Hybrid File Generator - bash dialect filter)
#

DOTFILES_DIR=~/dotfiles

echo "ğŸ’ª é­‚ã‚’PCã«å®¿ã‚‰ã›ã‚‹ãœï¼ï¼ˆv3.3 bashæ–¹è¨€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ­è¼‰å‹ï¼‰"

# --- 1. æœ€å¼·ã® .zshrc ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ ---
echo "--- .zshrcã‚’è‡ªå‹•ç”Ÿæˆä¸­... ---"
rm -f ~/.zshrc # ã¾ãšã€å¤ã„.zshrcãŒã‚ã‚Œã°å‰Šé™¤

{
  echo "# --- This file is auto-generated by dotfiles/setup.sh ---"
  echo "# --- DO NOT EDIT THIS FILE DIRECTLY ---"
  echo ""
  
  if [ -f ~/.bashrc ]; then
    echo "# --- æ—¢å­˜ã® .bashrc (ROSã®è¨­å®šãªã©) ã‹ã‚‰å®‰å…¨ãªè¨­å®šã®ã¿ã‚’èª­ã¿è¾¼ã¿ ---"
    
    # â˜…â˜…â˜…ã“ã“ãŒæœ€çµ‚é€²åŒ–ï¼â˜…â˜…â˜…
    # shopt, complete, bash_completion ã‚’å«ã‚€è¡Œã¯é™¤å¤–ã—ã¦å–ã‚Šè¾¼ã‚€
    grep -vE '^(source )?/usr/share/bash-completion/bash_completion' ~/.bashrc | grep -vE 'shopt|complete'
    # â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    
    echo ""
  fi

  if [ -f "$DOTFILES_DIR/zsh/.zshrc" ]; then
    echo "# --- kokkoã®æœ€å¼·ZSHè¨­å®š (Prezto, P10k) ã‚’èª­ã¿è¾¼ã¿ ---"
    cat "$DOTFILES_DIR/zsh/.zshrc"
    echo ""
  fi
  
} >> ~/.zshrc # å‡ºæ¥ä¸ŠãŒã£ãŸå†…å®¹ã‚’ ~/.zshrc ã«æ›¸ãå‡ºã™

echo "âœ… æœ€å¼·ã® .zshrc ãŒç”Ÿæˆã•ã‚ŒãŸãœï¼"


# --- 2. ä»–ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.gitconfigãªã©ï¼‰ã‚’ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã™ã‚‹ ---
echo "--- ä»–ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ³ã‚¯ä¸­... ---"

# (ã“ã“ã‹ã‚‰ä¸‹ã® create_safe_link é–¢æ•°ã¨ã€ãã‚Œä»¥é™ã®å‡¦ç†ã¯ã€
# ã“ã®å‰ã® v3.2 ã®ã¾ã¾ã§OKï¼å¤‰æ›´ãªã—ï¼)

create_safe_link() {
  source_path=$1
  link_target=$2
  mkdir -p "$(dirname "$link_target")"
  if [ -e "$link_target" ] && [ ! -L "$link_target" ]; then
    echo "âš ï¸ $link_target ã‚’ $link_target.bak ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚"
    mv "$link_target" "$link_target.bak"
  fi
  rm -f "$link_target"
  ln -s "$source_path" "$link_target"
  echo "âœ… $link_target ã‚’ãƒªãƒ³ã‚¯ã—ã¾ã—ãŸï¼"
}

# --- å…±é€šã§ãƒªãƒ³ã‚¯ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ« ---
create_safe_link "$DOTFILES_DIR/zsh/.zpreztorc"  "$HOME/.zpreztorc"
create_safe_link "$DOTFILES_DIR/zsh/.p10k.zsh"   "$HOME/.p10k.zsh"
create_safe_link "$DOTFILES_DIR/git/.gitconfig"  "$HOME/.gitconfig"

# --- WSLã˜ã‚ƒãªã‘ã‚Œã°ã€Linuxå°‚ç”¨ãƒªãƒ³ã‚¯ã‚‚å®Ÿè¡Œ ---
if ! grep -qi "microsoft" /proc/version; then
  echo "---"
  echo "ğŸ§ Linuxå°‚ç”¨è¨­å®šã‚’ãƒªãƒ³ã‚¯ä¸­... ---"
  create_safe_link "$DOTFILES_DIR/config/mozc"                "$HOME/.config/mozc"
  create_safe_link "$DOTFILES_DIR/vscode/settings.json"  "$HOME/.config/Code/User/settings.json"
  create_safe_link "$DOTFILES_DIR/vscode/snippets"      "$HOME/.config/Code/User/snippets"
  create_safe_link "$DOTFILES_DIR/config/user-dirs.dirs"      "$HOME/.config/user-dirs.dirs"
else
  echo "ğŸ§ WSLãªã®ã§Linuxå°‚ç”¨è¨­å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

echo ""
echo "âœ¨ ãƒªãƒ³ã‚¯ä½œæ¥­å®Œäº†ï¼"