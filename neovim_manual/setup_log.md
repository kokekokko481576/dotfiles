# NeoVim 環境構築ログ

このドキュメントは、このNeoVim環境の構築過程と、その背景にある技術的な判断を記録したものです。
将来、設定変更を依頼したり、ご自身で環境をメンテナンスしたりする際の参考情報となることを目的としています。

## 目次

- [依頼内容の要約](#依頼内容の要約)
- [最終的な構成の概要](#最終的な構成の概要)
- [構築プロセスと判断](#構築プロセスと判断)
  - [1. NeoVim本体のインストール](#1-neovim本体のインストール)
  - [2. 設定の基本方針](#2-設定の基本方針)
  - [3. LaTeX環境構築（苦難の道のり）](#3-latex環境構築苦難の道のり)
    - [3.1. `VimtexCompile` の謎のエラー](#31-vimtexcompile-の謎のエラー)
    - [3.2. `pgfplots`グラフ描画問題](#32-pgfplotsグラフ描画問題)
    - [3.3. `lualatex`への全面移行（最終解決策）](#33-lualatexへの全面移行最終解決策)
    - [3.4. キーマップのロード順序問題](#34-キーマップのロード順序問題)
  - [4. 最終的なLaTeXワークフロー](#4-最終的なlatexワークフロー)
- [その他](#その他)

---

## 依頼内容の要約

- **目的:** NeoVimでC/C++、Python、LaTeXを使ったロボット制御やレポート執筆のための開発環境を構築する。
- **要件:**
  - 初心者にも使いやすい、標準的で人気のある設定。
  - 拡張性が高いこと。
  - 便利な機能（ファイル検索、コード補完など）を含むこと。
  - 将来的にdotfilesで管理できる構成であること。
  - MarkdownとMermaid記法のサポート。

## 最終的な構成の概要

- **エディタ本体:** NeoVim `v0.12.0-dev` (`unstable` PPA経由でのシステムインストール)
- **設定言語:** Lua
- **設定ディレクトリ:** `~/.config/nvim` （`init.lua`, `settings.lua`, `packer.lua`, `keymaps.lua` に分割）
- **プラグインマネージャー:** `packer.nvim`
- **主要機能:** LSPによるコードインテリジェンス、Telescopeによる高速な検索、Git連携、Markdownプレビュー、内蔵ターミナル、キーマップヒント。
- **サポート言語:** C, C++, Python, LaTeX, Markdown。

## 構築プロセスと判断

### 1. NeoVim本体のインストール

- **問題:** 当初、`stable` PPAから古いNeoVim (`v0.7.2`) がインストールされ、プラグインとの互換性問題が発生した。
- **解決策:** `unstable` PPAを利用して最新開発版のNeoVim (`v0.12.0-dev`) をインストールすることで問題を根本的に解決した。

### 2. 設定の基本方針

- **言語:** 設定記述言語として、現在の主流である**Lua**を採用。
- **構成:** 設定を機能ごとにファイル分割（`settings.lua`, `keymaps.lua`, `packer.lua`など）し、`~/.config/nvim`ディレクトリに集約。これにより、見通しが良く、dotfilesでの管理が容易になる。
- **プラグイン管理:** **`packer.nvim`** を採用。Luaベースの設定との親和性が高く、コミュニティで広く使われているため。

### 3. LaTeX環境構築（苦難の道のり）

当初の目的は、既存の`platex`ベースの環境でコンパイルを通すことでした。しかし、様々な問題が複雑に絡み合い、最終的には**最新の`lualatex`環境へ移行する**ことで、すべての問題を解決しました。

#### 3.1. `VimtexCompile` の謎のエラー

- **問題:** `:VimtexCompile` を実行すると、`platex`ではなく`pdflatex`が使われようとして、大量のエラーが発生。
- **調査と試行:**
  - `vimtex`のコンパイラ設定 (`vim.g.vimtex_compiler_latexmk`) を`packer.lua`に記述するも、効果なし。
  - `.latexmkrc`ファイルで`platex`を強制しようとするも、Neovim内からの実行時になぜか無視される。
  - `packer.lua`の`init`ブロックや`config`ブロックなど、設定の読み込みタイミングを様々に変更するも、解決せず。
- **原因特定:** `:checkhealth`を実行した結果、LSPサーバーである`texlab`が独自のビルド設定（`-pdf`オプション付き）で`vimtex`の設定を上書きしていたことが判明。
- **対策:** `lsp-zero`の作法に則り、`texlab`のビルド設定を`platex`を使うように上書きすることで、`:VimtexCompile`が`platex`を呼び出すようになった。

#### 3.2. `pgfplots`グラフ描画問題

- **問題:** `platex`でのコンパイルは通るようになったが、`pgfplots`で作成したグラフがPDFに描画されない。これは`platex`→`dvipdfmx`という変換プロセスと`pgfplots`の相性問題が原因。
- **調査と試行:**
  - `tikz/externalize`機能（グラフだけを別ファイルとして`pdflatex`でコンパイルする）を試みるも、`-shell-escape`オプションの引数渡しが困難を極め、断念。

#### 3.3. `lualatex`への全面移行（最終解決策）

- **決断:** `platex`環境での安定動作を諦め、日本語・Unicode・PDF直接生成・`pgfplots`との連携に強い、最新のコンパイルエンジン **`lualatex`** へ全面的に移行することを決断。
- **移行作業:**
  1.  **`Template.tex`の修正:** ドキュメントクラスを`jsarticle`から`lualatex`対応の`ltjsarticle`に変更。`graphicx`や`hyperref`から`dvipdfmx`オプションを削除。
  2.  **`.latexmkrc`の修正:** コンパイルエンジンを`lualatex`に指定 (`$latex = 'lualatex %O %S'; $pdf_mode = 4;`)。
  3.  **`pgfplots`の構文エラー修正:** `lualatex`環境でも発生した `! Missing } inserted.` エラーの原因が、`axis`環境のオプション末尾の不要なカンマであることを特定し、`Template.tex`から削除。

#### 3.4. キーマップのロード順序問題

- **問題:** コンパイルを簡単にするためのカスタムキーマップ`<leader>lc`が、`Vimtex is not loaded`や`Unknown function`エラーで動作しない。
- **原因:** `keymaps.lua`が、依存するプラグイン(`toggleterm`, `vimtex`)よりも先に読み込まれてしまい、キーマップ定義時点でプラグインの関数が利用できなかったため。
- **最終的なアーキテクチャ:**
  1.  `packer.lua`は、プラグインのリストと基本的な`setup`のみを記述する。
  2.  `keymaps.lua`に、すべてのキーマップ定義を集約。
  3.  `init.lua`の最後に`autocmd VimEnter * ...`を記述し、Neovimの起動と**すべてのプラグインの読み込みが完了した後**に`keymaps.lua`で定義した関数を呼び出してキーマップを設定する方式に変更。これにより、ロード順序の問題を完全に解決。

### 4. 最終的なLaTeXワークフロー

- **コンパイルエンジン:** `lualatex`
- **コンパイル方法:**
  - `.tex`ファイルを開いた状態で`<leader>lc`を押す。
  - バックグラウンドで`latexmk`による継続的コンパイルが開始され、同時にPDFビューアー(`zathura`)が起動する。
  - あとはNeovimでファイルを編集して保存するだけで、PDFが自動的に更新される。
- **コンパイル停止:** `<leader>lk`を押す。

### 5. Mermaid レンダリング問題のデバッグ

- **問題:** `iamcco/markdown-preview.nvim` を利用したMarkdownプレビューで、特定の `mermaid` フローチャートが "Syntax error in text mermaid version 10.2.3" というエラーを出して表示されない。
- **調査と試行:**
  - **仮説1: サブグラフ名の問題:** 当初、サブグラフ名に日本語や記号、スペースが含まれていることが原因と推測。サブグラフ名をシンプルな英語 (`Initialization`など) に変更したが、解決せず。
  - **仮説2: 構文要素の特定:** 問題を切り分けるため、ごく簡単な `A --> B` という図から始め、以下の要素を一つずつ追加してテストする体系的なデバッグを実施。
    1. 日本語のノード名 (`A[テスト]`) → 成功
    2. サブグラフ (`subgraph ... end`) → 成功
    3. 日本語のリンクテキスト (`A -- テキスト --> B`) → 成功
    4. 複数サブグラフと、それらを繋ぐリンク → 成功
    5. グラフのループ（サイクル） → 成功
    6. 1ノードから複数ノードへの分岐 → 成功
  - **デバッグの結論:** `mermaid` の基本的な構文要素はすべて正しくレンダリングされることが確認された。これにより、問題は単体の構文ではなく、非常に特殊なケースか、見落としている些細な文字の問題である可能性が濃厚となった。
- **原因特定:**
  - 上記の体系的なデバッグの末、**ユーザー自身が**根本原因を発見。
  - **犯人:** リンクテキスト内の**全角の感嘆符 (`！`)**。
  - `mermaid v10.2.3` のパーサーが、リンクテキスト内の全角感嘆符を構文エラーとして誤認識するバグが原因であると断定。
- **最終的な対策:**
  - ユーザーがエラーの原因となる全角の `！` を半角の `!` に修正することで、無事レンダリングされることを確認。
  - こちらで施したサブグラフ名変更の修正は、原因ではなかったため元の状態に差し戻した。

## その他

- `checkhealth`で表示される`ripgrep not found`などの警告は、`telescope`の追加機能などで必要になるツールです。現状の基本的な動作には影響ありませんが、必要に応じて`sudo apt install ripgrep`などでインストールすると、より高機能になります。

### 3.5. キーマップの上書き問題とftpluginによる解決

- **問題:** `<leader>lc`で継続的コンパイルを開始するカスタムキーマップを`keymaps.lua`に定義していたが、LaTeXプラグインである`vimtex`が自身のデフォルトキーマップ（`<leader>lc`は中間ファイルのクリーンアップ）を後からロードするため、カスタムキーマップが上書きされてしまい、意図した動作にならない。
- **原因:** `vimtex`がファイルタイプ(`tex`)を認識した際に、独自のキーマップを設定する仕組みになっているため、汎用的な`keymaps.lua`の設定が負けてしまう。
- **最終的なアーキテクチャ:**
  1.  **`ftplugin`の活用:** Neovimの`after/ftplugin/`という仕組みを利用。このディレクトリに`tex.lua`というファイルを置くことで、`.tex`ファイルを開いたときに**`vimtex`のキーマップ設定よりも後で**、独自のキーマップをロードさせることができる。
  2.  **`~/.config/nvim/after/ftplugin/tex.lua`の作成:**
      - LaTeXファイル専用のキーマップ設定ファイルとして新規作成。
      - `<leader>lc`には、`toggleterm`を使い、`latexmk -pvc`を実行して継続的コンパイルを開始し、`zathura`でPDFを開くLua関数をマッピング。
      - `<leader>lk`には、実行中の`latexmk`プロセスを停止する関数をマッピング。
  3.  **`~/.config/nvim/lua/user/keymaps.lua`の整理:**
      - 汎用キーマップファイルである`keymaps.lua`からは、LaTeX専用だった`<leader>lc`と`<leader>lk`の定義を削除。
      - これにより、各ファイルタイプの固有設定が汎用設定を汚染しない、よりクリーンで保守性の高い構成になった。
- **結果:** この変更により、`.tex`ファイルを開いた際には常に意図した通りのコンパイル用キーマップが有効になり、`vimtex`のデフォルト設定との衝突が解決された。

### 3.6. 既存`.tex`ファイルの移行と`latexmk`の最終デバッグ

- **問題:** `ftplugin`でキーマップを分離した後も、既存の`.tex`ファイルでコンパイルが失敗。`lualatex`ではなく`platex`が実行され続けていた。
- **デバッグプロセス:**
  - **原因1: `.tex`ファイル自体:** 既存のファイルが`	extbackslash{}documentclass{jsarticle}`や`dvipdfmx`オプションなど、`platex`用の記述になっていた。これを`lualatex`用に修正しても、問題は解決せず。
  - **原因2: `.latexmkrc`の誤設定:** 根本原因は、ホームディレクトリの`~/.latexmkrc`にあった。このファイルが`platex`を使うように`latexmk`全体を強制していたため、`.tex`ファイルを修正しても意味がなかった。
  - **原因3: `platex`専用パッケージ:** `.latexmkrc`を修正して`lualatex`が動くようになると、今度は`pxjahyper`という`platex`専用パッケージがエラーを引き起こした。
- **最終的な解決策:**
  1. `~/.latexmkrc`を、`lualatex`を正しく使う設定 (`$latex = 'lualatex %O %S'; $pdf_mode = 4;`) に上書き修正。
  2. 既存の`.tex`ファイルから、`lualatex`と互換性のない`	extbackslash{}usepackage{pxjahyper}`の行を削除。
- **結果:** これら全ての修正により、既存の`platex`環境が、完全にモダンな`lualatex`環境へと移行完了。キーマップも意図通りに動作し、すべての`.tex`ファイルが正しく継続的コンパイルされるようになった。

## 6. dotfilesによるNeovim環境管理

- **目的:** Neovimの設定を`dotfiles`リポジトリで管理し、異なる環境でも同じ設定を簡単に再現できるようにする。
- **作業内容:**
  1. **設定ファイルの移動:** 既存の `~/.config/nvim` ディレクトリを、`~/dotfiles/config/nvim` に移動。
  2. **シンボリックリンクの作成:** 元の場所 (`~/.config/nvim`) に、移動先へのシンボリックリンクを作成。
  3. **専用セットアップスクリプトの作成:** `setup.sh` とは別に、Neovimの設定のみをセットアップするための `~/dotfiles/setup_neovim.sh` を新規に作成。このスクリプトは、上記シンボリックリンクを自動で作成する。
- **理由:**
  - `dotfiles`で一元管理することで、設定のバックアップと復元が容易になる。
  - `setup_neovim.sh` を分離することで、Neovimを必要としない環境ではセットアップをスキップでき、モジュール性が向上する。
